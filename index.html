<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Othello</title>

<style>
body {
  margin: 0;
  background: #2c3e50;
  color: #ecf0f1;
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

h1 { margin-bottom: 10px; }

#status {
  margin-bottom: 10px;
  padding: 8px 20px;
  background: rgba(255,255,255,0.1);
  border-radius: 20px;
}

#board {
  display: grid;
  grid-template-columns: repeat(8, 45px);
  gap: 4px;
}

.cell {
  width: 45px;
  height: 45px;
  background: #27ae60;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.cell.disabled {
  cursor: default;
  opacity: 0.6;
}

.disc {
  width: 36px;
  height: 36px;
  border-radius: 50%;
}

.black { background: black; }
.white { background: white; }
</style>
</head>

<body>
<h1>ONLINE OTHELLO</h1>
<div id="status">接続中...</div>
<div id="board"></div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update, onDisconnect, serverTimestamp }
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, signInAnonymously }
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqzjuOEB7P5n_gtSwDUtaMa_CbtgAIeUk",
  authDomain: "online-game-572f5.firebaseapp.com",
  databaseURL: "https://online-game-572f5-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "online-game-572f5",
  storageBucket: "online-game-572f5.firebasestorage.app",
  messagingSenderId: "199079474526",
  appId: "1:199079474526:web:f7ffc6096d3173fb63cbcf"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ===== State ===== */
let myId = null;
let myColor = 0; // 1=黒 2=白

/* ===== Auth ===== */
signInAnonymously(auth).then(result => {
  myId = result.user.uid;
  setupPresence();
  claimSeat();
});

/* ===== Presence ===== */
function setupPresence() {
  const p = ref(db, "presence/" + myId);
  set(p, { online: true, lastSeen: serverTimestamp() });
  onDisconnect(p).remove();
  setInterval(() => {
    set(p, { online: true, lastSeen: serverTimestamp() });
  }, 10000);
}

/* ===== Seat ===== */
function claimSeat() {
  const seatsRef = ref(db, "seats");
  onValue(seatsRef, snap => {
    const seats = snap.val() || {};
    if (seats.black === myId) myColor = 1;
    else if (seats.white === myId) myColor = 2;
    else if (!seats.black) set(ref(db, "seats/black"), myId);
    else if (!seats.white) set(ref(db, "seats/white"), myId);
  });
}

/* ===== Init Game ===== */
const gameRef = ref(db, "game");
onValue(gameRef, snap => {
  if (!snap.exists()) initGame();
});

function initGame() {
  const board = Array(64).fill(0);
  board[27]=2; board[28]=1;
  board[35]=1; board[36]=2;
  set(gameRef, { board, turn: 1 });
}

/* ===== Render ===== */
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");

onValue(gameRef, snap => {
  const data = snap.val();
  if (!data) return;
  render(data.board, data.turn);
});

function render(board, turn) {
  boardEl.innerHTML = "";
  statusEl.textContent =
    (myColor === turn ? "あなたの番" : "相手の番") +
    ` (${turn === 1 ? "黒" : "白"})`;

  board.forEach((v,i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    if (v !== 0 || myColor !== turn) cell.classList.add("disabled");
    cell.onclick = () => clickCell(i);
    if (v !== 0) {
      const d = document.createElement("div");
      d.className = "disc " + (v===1?"black":"white");
      cell.appendChild(d);
    }
    boardEl.appendChild(cell);
  });
}

/* ===== Click ===== */
function clickCell(i) {
  onValue(gameRef, snap => {
    const { board, turn } = snap.val();
    if (turn !== myColor) return;
    const newBoard = [...board];
    if (place(newBoard, i, turn)) {
      update(gameRef, {
        board: newBoard,
        turn: turn === 1 ? 2 : 1
      });
    }
  }, { onlyOnce:true });
}

/* ===== Othello Logic ===== */
function place(board, idx, color) {
  if (board[idx] !== 0) return false;
  const opp = color===1?2:1;
  const dirs=[-9,-8,-7,-1,1,7,8,9];
  let ok=false;
  for (let d of dirs) {
    let path=[];
    let c=idx+d;
    while (c>=0 && c<64) {
      const x=c%8, px=(c-d)%8;
      if (Math.abs(x-px)>1) break;
      if (board[c]===opp) path.push(c);
      else if (board[c]===color) {
        if (path.length) {
          path.forEach(p=>board[p]=color);
          ok=true;
        }
        break;
      } else break;
      c+=d;
    }
  }
  if (ok) board[idx]=color;
  return ok;
}
</script>
</body>
</html>
