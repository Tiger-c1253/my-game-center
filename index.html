<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Board Games</title>
<style>
body{
  margin:0; font-family:sans-serif; background:#2c3e50; color:#ecf0f1;
  display:flex; flex-direction:column; align-items:center;
}
h1{margin:15px 0}
#menu button{
  margin:5px; padding:10px 30px; font-size:18px; border-radius:30px;
}
#status{margin:10px}
#board{
  display:grid; gap:6px; background:#34495e; padding:10px; border-radius:10px;
}
.cell{
  width:44px; height:44px; background:#27ae60;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; border-radius:6px;
}
.connect4 .cell{background:#2980b9; border-radius:50%}
.disc{
  width:36px; height:36px; border-radius:50%;
}
.black{background:#000}
.white{background:#fff}
.red{background:#e74c3c}
.yellow{background:#f1c40f}
</style>
</head>
<body>

<h1>ONLINE BOARD GAME</h1>

<div id="menu">
  <button onclick="startGame('othello')">オセロ</button>
  <button onclick="startGame('connect4')">コネクト4</button>
</div>

<div id="status">待機中...</div>
<div id="board"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

/* Firebase設定（あなたのもの） */
const firebaseConfig = {
  apiKey: "AIzaSyBqzjuOEB7P5n_gtSwDUtaMa_CbtgAIeUk",
  authDomain: "online-game-572f5.firebaseapp.com",
  databaseURL: "https://online-game-572f5-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "online-game-572f5",
  storageBucket: "online-game-572f5.firebasestorage.app",
  messagingSenderId: "199079474526",
  appId: "1:199079474526:web:f7ffc6096d3173fb63cbcf"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
await signInAnonymously(auth);

const myId = auth.currentUser.uid;

const refs = {
  game: ref(db,"game"),
  board: ref(db,"board"),
  turn: ref(db,"turn"),
  players: ref(db,"players")
};

let gameType=null, board=[], turn=1, myColor=0;

/* プレイヤー割当 */
onValue(refs.players,s=>{
  const p=s.val()||{};
  if(!p.black) set(ref(db,"players/black"),myId);
  else if(!p.white && p.black!==myId) set(ref(db,"players/white"),myId);
  myColor = p.black===myId?1:p.white===myId?2:0;
});

/* 状態同期 */
onValue(refs.game,s=>{gameType=s.val(); draw();});
onValue(refs.board,s=>{board=s.val()||[]; draw();});
onValue(refs.turn,s=>{turn=s.val(); drawStatus();});

window.startGame=(type)=>{
  if(myColor!==1) return;
  if(type==="othello"){
    board=Array(64).fill(0);
    board[27]=2; board[28]=1; board[35]=1; board[36]=2;
    set(refs.turn,1);
  }else{
    board=Array(42).fill(0);
    set(refs.turn,1);
  }
  set(refs.game,type);
  set(refs.board,board);
};

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  if(!gameType) return;
  if(gameType==="othello"){
    b.style.gridTemplateColumns="repeat(8,44px)";
    b.className="";
  }else{
    b.style.gridTemplateColumns="repeat(7,44px)";
    b.className="connect4";
  }
  board.forEach((v,i)=>{
    const c=document.createElement("div");
    c.className="cell";
    c.onclick=()=>clickCell(i);
    if(v){
      const d=document.createElement("div");
      d.className="disc "+(
        gameType==="othello"?(v===1?"black":"white"):(v===1?"red":"yellow")
      );
      c.appendChild(d);
    }
    b.appendChild(c);
  });
  drawStatus();
}

function drawStatus(){
  const s=document.getElementById("status");
  if(!gameType){s.innerText="ゲーム選択中";return;}
  if(myColor===0){s.innerText="観戦中";return;}
  s.innerText=(turn===myColor?"あなたの番":"相手の番");
}

function clickCell(i){
  if(myColor!==turn) return;
  const newBoard=[...board];
  let ok=false;
  if(gameType==="othello") ok=placeOthello(newBoard,i,myColor);
  else ok=placeConnect4(newBoard,i,myColor);
  if(ok){
    set(refs.board,newBoard);
    set(refs.turn,myColor===1?2:1);
  }
}

/* オセロ */
function placeOthello(b,i,c){
  if(b[i]!==0) return false;
  const o=c===1?2:1;
  const d=[-9,-8,-7,-1,1,7,8,9];
  let f=false;
  for(const k of d){
    let p=[],n=i+k;
    while(n>=0&&n<64){
      const r=Math.floor(n/8),c2=n%8;
      const pr=Math.floor((n-k)/8),pc=(n-k)%8;
      if(Math.abs(r-pr)>1||Math.abs(c2-pc)>1) break;
      if(b[n]===o) p.push(n);
      else if(b[n]===c){if(p.length){p.forEach(x=>b[x]=c);f=true;}break;}
      else break;
      n+=k;
    }
  }
  if(f) b[i]=c;
  return f;
}

/* コネクト4 */
function placeConnect4(b,i,c){
  const col=i%7;
  for(let r=5;r>=0;r--){
    const n=r*7+col;
    if(b[n]===0){b[n]=c;return true;}
  }
  return false;
}
</script>
</body>
</html>
