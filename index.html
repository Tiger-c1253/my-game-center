<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Game Center</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --menu-bg: #34495e;
            --accent: #f1c40f;
            --text: #ecf0f1;
        }
        body {
            font-family: sans-serif; background-color: var(--bg-color); color: var(--text);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; user-select: none;
        }
        h1 { margin: 0 0 20px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* メニュー画面 */
        #menu-screen { display: none; flex-direction: column; gap: 20px; text-align: center; }
        .game-btn {
            padding: 15px 40px; font-size: 1.2rem; border: none; border-radius: 50px;
            cursor: pointer; background: var(--accent); color: #333; font-weight: bold;
            box-shadow: 0 4px 0 #c0392b; transition: transform 0.1s;
        }
        .game-btn:active { transform: translateY(4px); box-shadow: none; }
        .waiting-text { font-size: 0.9rem; opacity: 0.7; margin-top: 10px; }

        /* ゲーム画面 */
        #game-screen { display: none; flex-direction: column; align-items: center; }
        #status-card {
            background: rgba(255,255,255,0.1); padding: 10px 30px; border-radius: 50px;
            margin-bottom: 20px; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 10px;
        }
        #board-frame {
            padding: 15px; background-color: #34495e; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #board { display: grid; gap: 4px; }
        
        .cell {
            width: 45px; height: 45px; background-color: #27ae60; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        /* コネクトフォー用のスタイル上書き */
        .connect4 .cell { background-color: #2980b9; border-radius: 50%; }
        .connect4 #board { gap: 8px; background-color: #3498db; padding: 5px; border-radius: 10px; }

        .disc {
            width: 36px; height: 36px; border-radius: 50%; display: block;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .black { background: radial-gradient(circle at 30% 30%, #555, #000); }
        .white { background: radial-gradient(circle at 30% 30%, #fff, #ddd); }
        .red   { background: radial-gradient(circle at 30% 30%, #ff6b6b, #c0392b); }
        .yellow{ background: radial-gradient(circle at 30% 30%, #f1c40f, #f39c12); }

        /* リセットボタン */
        #reset-btn {
            margin-top: 20px; padding: 8px 20px; background: transparent; border: 1px solid #fff;
            color: #fff; border-radius: 20px; cursor: pointer; opacity: 0.6;
        }
        #reset-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }

        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <h1 id="title">GAME CENTER</h1>
    
    <div id="menu-screen">
        <h2>ゲームを選択してください</h2>
        <button class="game-btn" onclick="startGame('othello')">オセロ (Othello)</button>
        <button class="game-btn" onclick="startGame('connect4')">コネクト4 (Connect 4)</button>
        <div class="waiting-text" id="menu-msg">※ホスト（最初の人）が選択できます</div>
    </div>

    <div id="game-screen">
        <div id="status-card">
            <span id="turn-indicator" style="width:15px;height:15px;border-radius:50%;display:inline-block;"></span>
            <span id="status-text">...</span>
        </div>
        <div id="board-frame">
            <div id="board"></div>
        </div>
        <button id="reset-btn" onclick="resetToMenu()">メニューに戻る</button>
    </div>

    <script src="https://unpkg.com/playroomkit/multiplayer.js"></script>
    <script>
        const { insertCoin, isHost, setState, getState, myPlayer } = Playroom;
        
        let localState = { gameType: null, board: [], turn: 0 };

        insertCoin({ skipLobby: true }).then(() => {
            if (isHost()) {
                setState("gameType", null); // 初期はメニュー
            }
        });

        // ■ メインループ
        function loop() {
            const gameType = getState("gameType");
            const turn = getState("turn");
            const board = getState("board");
            const winner = getState("winner"); // 勝者判定用

            // 画面切り替え制御
            if (gameType !== localState.gameType) {
                localState.gameType = gameType;
                switchScreen(gameType);
            }

            // 盤面更新
            if (gameType && board) {
                // 変更検知（簡易）
                if (JSON.stringify(board) !== JSON.stringify(localState.board) || turn !== localState.turn || winner !== localState.winner) {
                    localState.board = board;
                    localState.turn = turn;
                    localState.winner = winner;
                    drawBoard(gameType, board, turn);
                    updateStatus(gameType, turn, winner);
                }
            }
            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

        // ■ 画面切り替え
        function switchScreen(type) {
            const menu = document.getElementById("menu-screen");
            const game = document.getElementById("game-screen");
            const frame = document.getElementById("board-frame");
            
            if (!type) {
                // メニュー表示
                menu.style.display = "flex";
                game.style.display = "none";
                document.getElementById("menu-msg").innerText = isHost() ? "ゲームを選んでください" : "ホストがゲームを選択中...";
                document.querySelectorAll(".game-btn").forEach(b => b.disabled = !isHost());
            } else {
                // ゲーム表示
                menu.style.display = "none";
                game.style.display = "flex";
                frame.className = (type === 'connect4') ? 'connect4' : ''; // CSSクラス切り替え
            }
        }

        // ■ ゲーム開始（ホストのみ実行）
        window.startGame = (type) => {
            if (!isHost()) return;
            let board, turn;
            
            if (type === 'othello') {
                board = Array(64).fill(0);
                board[27]=2; board[28]=1; board[35]=1; board[36]=2;
                turn = 1; 
            } else if (type === 'connect4') {
                board = Array(42).fill(0); // 7x6
                turn = 1;
            }
            
            setState("gameType", type);
            setState("board", board);
            setState("turn", turn);
            setState("winner", 0);
        }

        // ■ メニューに戻る
        window.resetToMenu = () => {
            if (isHost()) setState("gameType", null);
        }

        // ■ 描画処理
        function drawBoard(type, board, turn) {
            const boardEl = document.getElementById("board");
            boardEl.innerHTML = "";
            
            // CSS Gridの設定
            if (type === 'othello') {
                boardEl.style.gridTemplateColumns = "repeat(8, 45px)";
            } else {
                boardEl.style.gridTemplateColumns = "repeat(7, 45px)";
            }

            board.forEach((cell, index) => {
                const div = document.createElement("div");
                div.className = "cell";
                div.onclick = () => handleClick(type, index);
                
                if (cell !== 0) {
                    const disc = document.createElement("div");
                    disc.className = "disc";
                    // 色分けロジック
                    if (type === 'othello') {
                        disc.classList.add(cell === 1 ? "black" : "white");
                    } else {
                        disc.classList.add(cell === 1 ? "red" : "yellow"); // コネクト4は赤黄
                    }
                    div.appendChild(disc);
                }
                boardEl.appendChild(div);
            });
        }

        // ■ クリック処理（ゲーム分岐）
        function handleClick(type, index) {
            const turn = getState("turn");
            const board = getState("board");
            const winner = getState("winner");
            
            // 勝負がついているか、自分のターンでなければ無視（簡易：プレイヤーIDチェック省略）
            if (winner !== 0) return;

            let newBoard = [...board];
            let success = false;

            if (type === 'othello') {
                success = playOthello(newBoard, index, turn);
            } else if (type === 'connect4') {
                success = playConnect4(newBoard, index, turn);
            }

            if (success) {
                setState("board", newBoard);
                // 勝敗判定
                const win = (type === 'othello') ? 0 : checkWinConnect4(newBoard, turn);
                if (win) {
                    setState("winner", turn);
                } else {
                    setState("turn", turn === 1 ? 2 : 1);
                }
            }
        }

        // === オセロのロジック ===
        function playOthello(board, index, color) {
            if (board[index] !== 0) return false;
            const opponent = color === 1 ? 2 : 1;
            const directions = [-9,-8,-7,-1,1,7,8,9];
            let captured = false;
            
            for (let dir of directions) {
                let path = [];
                let curr = index + dir;
                while(curr >= 0 && curr < 64) {
                    // 行列ズレ防止
                    const cx = curr % 8, px = (curr - dir) % 8;
                    const cy = Math.floor(curr/8), py = Math.floor((curr-dir)/8);
                    if(Math.abs(cx - px) > 1 || Math.abs(cy - py) > 1) break;

                    if (board[curr] === opponent) path.push(curr);
                    else if (board[curr] === color) {
                        if (path.length > 0) {
                            path.forEach(p => board[p] = color);
                            captured = true;
                        }
                        break;
                    } else break;
                    curr += dir;
                }
            }
            if (captured) board[index] = color;
            return captured;
        }

        // === コネクトフォーのロジック（重力） ===
        function playConnect4(board, index, color) {
            const cols = 7; 
            const rows = 6;
            const col = index % cols; // クリックされた列
            
            // その列の一番下から探して、空いている場所に置く
            for (let r = rows - 1; r >= 0; r--) {
                const targetIdx = r * cols + col;
                if (board[targetIdx] === 0) {
                    board[targetIdx] = color;
                    return true; // 置けた
                }
            }
            return false; // 列がいっぱい
        }

        // === コネクトフォーの勝利判定 ===
        function checkWinConnect4(board, color) {
            // 横, 縦, 斜め右下, 斜め左下
            const directions = [1, 7, 8, 6]; 
            const cols = 7; const rows = 6;

            for (let i = 0; i < 42; i++) {
                if (board[i] !== color) continue;

                for (let dir of directions) {
                    let count = 1;
                    for (let step = 1; step < 4; step++) {
                        let next = i + dir * step;
                        // 境界チェック（簡易版：配列外および行またぎの変な判定を防ぐ）
                        if (next < 0 || next >= 42) break;
                        
                        // 横方向のチェック時、行が変わっていたらアウト
                        if (dir === 1) {
                            if (Math.floor(i / cols) !== Math.floor(next / cols)) break;
                        }
                        // 斜めなどの厳密な境界チェックは省略するが、
                        // 7x6の配列ではこの簡易チェックで概ね動作する
                        
                        if (board[next] === color) count++;
                        else break;
                    }
                    if (count === 4) return true;
                }
            }
            return false;
        }

        // ■ ステータス更新
        function updateStatus(type, turn, winner) {
            const text = document.getElementById("status-text");
            const indicator = document.getElementById("turn-indicator");
            
            if (winner !== 0) {
                text.innerText = (winner === 1 ? (type==='othello'?"黒":"赤") : (type==='othello'?"白":"黄")) + " の勝ち！";
                indicator.style.backgroundColor = "transparent";
                return;
            }

            let colorName, colorCode;
            if (type === 'othello') {
                colorName = turn === 1 ? "黒" : "白";
                colorCode = turn === 1 ? "#000" : "#fff";
            } else {
                colorName = turn === 1 ? "赤" : "黄";
                colorCode = turn === 1 ? "#c0392b" : "#f1c40f";
            }
            
            text.innerText = `${colorName} の番です`;
            indicator.style.backgroundColor = colorCode;
            indicator.style.boxShadow = (colorCode==="#fff") ? "0 0 5px #fff" : "none";
        }
    </script>
</body>
</html>